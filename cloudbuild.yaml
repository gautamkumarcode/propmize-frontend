steps:
  # 1Ô∏è‚É£ Install dependencies
  - name: 'gcr.io/cloud-builders/npm'
    args: ['ci']

  # 2Ô∏è‚É£ Build the Next.js app
  - name: 'gcr.io/cloud-builders/npm'
    args: ['run', 'build']
    env:
      - 'NEXT_PUBLIC_API_URL=${_NEXT_PUBLIC_API_URL}'
      - 'NEXT_PUBLIC_GOOGLE_CLIENT_ID=${_NEXT_PUBLIC_GOOGLE_CLIENT_ID}'

  # 3Ô∏è‚É£ Build Docker image
  - name: 'gcr.io/cloud-builders/docker'
    args: ['build', '-t', 'gcr.io/$PROJECT_ID/propmize-frontend:latest', '.']

  # 4Ô∏è‚É£ Push image
  - name: 'gcr.io/cloud-builders/docker'
    args: ['push', 'gcr.io/$PROJECT_ID/propmize-frontend:latest']

  # 5Ô∏è‚É£ Deploy to existing Cloud Run service (üîë main fix)
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: gcloud
    args:
      [
        'run',
        'deploy',
        'propmize-frontend',                 # ‚Üê Your existing service name here
        '--image', 'gcr.io/$PROJECT_ID/propmize-frontend:latest',
        '--region', 'us-central1',      # ‚Üê Use your region
        '--platform', 'managed',
        '--allow-unauthenticated'
      ]

images:
  - 'gcr.io/$PROJECT_ID/propmize-frontend:latest'
